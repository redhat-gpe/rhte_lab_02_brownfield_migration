:scrollbar:
:data-uri:
:toc2:
:linkattrs:

== Application Decomposition to Create Catalog Service Lab

In this lab, you decompose the `monolith-coolstore` application using Wildfly Swarm to create the `catalog-service` application.

The `catalog-service` application consists of a single Maven project that, like the `inventory-service` application, uses a REST API implemented using JAX-RS and JPA to expose its data access layer. The `catalog-service` service serves products and prices for retail products and is responsible for adding products to and retrieving product data from the catalog database. Wildfly Swarm is used as the runtime for the application. A PostgreSQL database is used for persistence.

.Goal
* Decompose the `monolith-coolstore` application using Wildfly Swarm to create the `catalog-service` application

.Prerequisites
* Import of `modern-coolstore/catalog-service` project code into JBoss Developer Studio
* Access to an OpenShift environment with the required projects set up
+
NOTE: Refer to instructions in the previous labs to complete either of these prerequisites.

:numbered:

== Review Catalog Service Code

. Review the source code for the `catalog-service` application:
+
****
*Questions*:

* What Maven dependencies and versions are used for persistence, CDI, and JAX-RS?
* What are the names of the datasource and persistence unit used?
* How is the JDBC driver injected into the code?
* What are the REST endpoints exposed by the service?
* What health checks are defined for OpenShift?
* What testing framework is used?
* What database is used for testing, and where is the configuration defined?
****


== Build and Package Application

WildFly Swarm applications are typically packaged and deployed as self-executing JAR files.

The executable WildFly Swarm JARs are automatically generated by the `wildfly-swarm-plugin` Maven plug-in.

. Review the project's POM file--specifically, the configuration of the WildFly Swarm Maven plug-in.
* The WildFly Swarm plug-in configuration repackages the WAR that is built by the Maven WAR goal during the _package_ phase of the Maven life cycle.
* The original WAR file is renamed to `<war file name>.war.original`.
* The self-executing JAR is named `<war file name>-swarm.jar`.
. From the command line, build the application with Maven:
+
[source,sh]
----
$ cd ~/labs/modern-coolstore/catalog-service/
$ mvn clean package
----

. Verify that a fat JAR is built in the target directory by checking the size of the built JARs:
+
[source,sh]
----
$ ls target/catalog-service*
----
+
.Sample Output
----
-rw-rw-r-- 1   2081902 Feb 28 13:29 catalog-service-1.0.0-SNAPSHOT.war
-rw-rw-r-- 1 106933844 Feb 28 13:29 catalog-service-1.0.0-SNAPSHOT-swarm.jar
-rw-rw-r-- 1  19542274 Feb 28 13:28 catalog-service-1.0.0-SNAPSHOT.war.original
----

== Review API Documentation with Swagger

Swagger automatically builds elegant and interactive API documentation for consumers of the API. This is achieved by having the service API return a YAML or JSON document that contains a detailed description of the API.

. Review the Swagger fraction dependencies in the `pom.xml` file:
+
[source,xml]
----
<dependency>
           <groupId>org.wildfly.swarm</groupId>
           <artifactId>swagger</artifactId>
</dependency>
----

. Review the `src/main/resources/META-INF/swarm.swagger.conf` configuration file.
* The file describes the API information as a whole.

. Review `src/main/java/com/redhat/coolstore/catalog/rest/CatalogResource.java` for annotations that define more specific API-relevant information:
* `@API`: Marks the class as a Swagger resource.
* `@ApiOperation`: Describes the operation or typically an HTTP method against specific path.
* `@ApiParam`: Adds additional metadata for operation parameters.

== Deploy on OpenShift

=== Review Health Checks

The `liveness` and `readiness` probes are defined using the Wildfly Swarm `monitor` fraction, which exposes a number of REST endpoints providing runtime status of the node, as well as access to the health check API. The health check API allows development of custom health check methods and exposes them as REST endpoints.

. Review the `HealthCheckResource` class in the `com.redhat.coolstore.catalog.rest` package.
* The `@Health` annotations register the method to the Wildfly Swarm health check API and are included in the `/health` endpoint.
* The `check` method returns a `HealthStatus` instance, which signifies the server state as `UP`.
* The health check API transforms the `HealthStatus` into a JSON payload:
+
[source,json]
----
{
  "id":"server-state",
  "result":"UP"
}
----

=== Create Project and Review Resource Limits and Quotas

. In OpenShift, create a new project for the `catalog-service`:
+
[source,sh]
----
$ oc new-project $USER-modern-catalog-service
----

. Review the `clusterquota` and `limitrange` objects.

=== Deploy PostgreSQL to OpenShift

. Deploy PostgreSQL using the `postgresql` image from the OpenShift namespace:
+
[source,sh]
----
oc new-app postgresql-persistent -e POSTGRESQL_USER=jboss -e POSTGRESQL_PASSWORD=jboss -e POSTGRESQL_DATABASE=catalogdb  -pDATABASE_SERVICE_NAME=catalog-postgresql
----

=== Create Configuration Map

To externalize the application configuration, you use the Wildfly Swarm _project stages_ approach. That is, you define a profile-specific YAML configuration.

. Review `~/labs/modern-coolstore/catalog-service/etc/project-defaults.yml` to study the database connection properties.

. Create the OpenShift configuration map using the `project-defaults.yml` template:
+
[source,sh]
----
$ cd ~/labs/modern-coolstore/catalog-service

$ oc create configmap app-config --from-file=etc/project-defaults.yml
----

=== Deploy with Fabric8 Maven Plug-in

In this section, you use the `fabric8-maven-plugin` plug-in to perform a binary source build.

* The plug-in uses `redhat-openjdk18-openshift:1.2` as the base image.
* The plug-in can be configured with an external configuration in the form of YAML resource descriptor fragments, which are located in the `src/main/fabric8` directory.

// required for correct indentation

. Review the `deployment.yml` and `route.yml` files.
+
****
*Questions*:

* For health checks, what endpoints are defined and what are their properties?
* Which system resources (CPU and memory) are defined for the application?
* How is the configuration made available inside the container?
****

. Deploy the application to OpenShift:
+
[source,sh]
----
$ mvn clean fabric8:deploy -Popenshift  -DskipTests
----

. Follow the output of `fabric8-maven-plugin` to check the status of application deployment:
+
.`fabric8:build` Sample Output
----
[INFO] --- fabric8-maven-plugin:3.5.28:build (default) @ catalog-service ---
[INFO] F8: Using OpenShift build with strategy S2I
[INFO] F8: Running generator wildfly-swarm
[INFO] F8: wildfly-swarm: Using ImageStreamTag 'redhat-openjdk18-openshift:1.2' as builder image
[INFO] Copying files to /home/jasingh/projects/gpe-mw-training/appmod-modern-migration/app-modernization-migration-lab/modern-coolstore/catalog-service/target/docker/catalog-service/latest/build/maven
[INFO] Building tar: /home/jasingh/projects/gpe-mw-training/appmod-modern-migration/app-modernization-migration-lab/modern-coolstore/catalog-service/target/docker/catalog-service/latest/tmp/docker-build.tar
[INFO] F8: [catalog-service:latest] "wildfly-swarm": Created docker source tar /home/jasingh/projects/gpe-mw-training/appmod-modern-migration/app-modernization-migration-lab/modern-coolstore/catalog-service/target/docker/catalog-service/latest/tmp/docker-build.tar
[INFO] F8: Using BuildServiceConfig catalog-service-s2i for Source strategy
[INFO] F8: Adding to ImageStream catalog-service
[INFO] F8: Starting Build catalog-service-s2i
[INFO] F8: Waiting for build catalog-service-s2i-1 to complete...
[INFO] F8: Build catalog-service-s2i-1 Complete
----
+
.`fabric8:deploy` Sample Output
----
[INFO] --- fabric8-maven-plugin:3.5.28:deploy (default-cli) @ catalog-service ---
[INFO] F8: Using OpenShift at https://192.168.0.106:8443/ in namespace catalog with manifest /home/jasingh/projects/gpe-mw-training/appmod-modern-migration/app-modernization-migration-lab/modern-coolstore/catalog-service/target/classes/META-INF/fabric8/openshift.yml
[INFO] OpenShift platform detected
[INFO] Using project: catalog
[INFO] Creating a Service from openshift.yml namespace catalog name catalog-service
[INFO] Created Service: target/fabric8/applyJson/catalog/service-catalog-service.json
[INFO] Using project: catalog
[INFO] Creating a DeploymentConfig from openshift.yml namespace catalog name catalog-service
[INFO] Created DeploymentConfig: target/fabric8/applyJson/catalog/deploymentconfig-catalog-service.json
[INFO] Creating Route catalog:catalog-service host: null
[INFO] F8: HINT: Use the command `oc get pods -w` to watch your pods start up
----

. Determine the status of the deployment:
+
[source,sh]
----
$ oc get pods
----
+
.Sample Output
----
catalog-postgresql-1-454hr    1/1       Running     0          20m
catalog-service-1-qfjcq       1/1       Running     0          9m
----

. Examine the application logs to make sure that the application started successfully:
+
[source,sh]
----
$ oc logs -f catalog-service-1-qfjcq
----
+
.Sample Output
----
2018-02-28 12:03:07,470 INFO  [org.hibernate.envers.boot.internal.EnversServiceImpl] (ServerService Thread Pool -- 12) Envers integration enabled? : true
2018-02-28 12:03:08,598 INFO  [org.hibernate.tool.hbm2ddl.SchemaExport] (ServerService Thread Pool -- 12) HHH000227: Running hbm2ddl schema export
2018-02-28 12:03:08,603 INFO  [stdout] (ServerService Thread Pool -- 12) Hibernate: drop table if exists PRODUCT_CATALOG cascade
2018-02-28 12:03:08,605 INFO  [stdout] (ServerService Thread Pool -- 12) Hibernate: create table PRODUCT_CATALOG (itemId varchar(255) not null, description varchar(255), name varchar(255), price float8 not null, primary key (itemId))
2018-02-28 12:03:08,625 INFO  [org.hibernate.tool.hbm2ddl.SchemaExport] (ServerService Thread Pool -- 12) HHH000476: Executing import script 'init-catalog.sql'
2018-02-28 12:03:08,652 INFO  [org.hibernate.tool.hbm2ddl.SchemaExport] (ServerService Thread Pool -- 12) HHH000230: Schema export complete
2018-02-28 12:03:11,165 INFO  [org.jboss.resteasy.resteasy_jaxrs.i18n] (ServerService Thread Pool -- 14) RESTEASY002225: Deploying javax.ws.rs.core.Application: class org.wildfly.swarm.generated.WildFlySwarmDefaultJAXRSApplication
2018-02-28 12:03:11,283 INFO  [org.wildfly.extension.undertow] (ServerService Thread Pool -- 14) WFLYUT0021: Registered web context: /
2018-02-28 12:03:11,449 INFO  [org.jboss.as.server] (main) WFLYSRV0010: Deployed "catalog-service-1.0.0-SNAPSHOT.war" (runtime-name : "catalog-service-1.0.0-SNAPSHOT.war")
2018-02-28 12:03:11,570 INFO  [org.wildfly.swarm] (main) WFSWARM99999: WildFly Swarm is Ready
----

== Examine Quotas and Limits for OpenShift Resources

. Review the resources defined for the PostgreSQL application's deployment configuration:
+
[source,sh]
----
$  oc get dc catalog-postgresql  -o jsonpath='{ .spec.template.spec.containers[0].resources }'
----
+
.Sample Output
----
map[limits:map[memory:512Mi]]
----

. Review the resources defined for the catalog service's deployment configuration:
+
[source,sh]
----
$ oc get dc catalog-service  -o jsonpath='{ .spec.template.spec.containers[0].resources }'
----
+
.Sample Output
----
map[limits:map[cpu:1 memory:1Gi] requests:map[memory:500Mi cpu:100m]
----

. Review the cluster quota and determine the values for:
* `limits.cpu`
* `limits.memory`
* `requests.cpu`
* `requests.memory`

== Test Catalog Service Application

. Determine the URL of the application and set an environment variable with its value:
+
[source,sh]
----
$ export MODERN_CATALOG_URL=http://$(oc get route catalog-service  -o template --template='{{.spec.host}}')
----

. Invoke the health check endpoint:
+
[source,sh]
----
$ curl -X GET "$MODERN_CATALOG_URL/health"
----
+
.Sample Output
[source,json]
----
{"checks": [
{"id":"server-state","result":"UP"}],
"outcome": "UP"
}
----

. Retrieve the Swagger description:
+
[source,sh]
----
$ curl -X GET "$MODERN_CATALOG_URL/swagger.json | jq
----
+
.Sample Output
[source,json]
----
{
  "swagger": "2.0",
  "info": {
    "description": "The API for catalog service",
    "version": "1.0.0",
    "title": "Catalog Service REST API"
  },
  "basePath": "/catalog",
  "tags": [
    {
      "name": "The catalog service"
    }
  ],
  "paths": {
    "/catalog/products": {
      "get": {
        "tags": [
          "The catalog service"
        ],
        "summary": "Retrieve all catalog items",
        "description": "",
        "operationId": "listAll",
        "consumes": [
          "application/json"
        ],
        "produces": [
          "application/json"
        ],
        "parameters": [],
        "responses": {
          "200": {
            "description": "successful operation",
            "schema": {
              "type": "array",
              "items": {
                "$ref": "#/definitions/Product"
              }
            }
          }
        }
      }
    },
  ...
}
----

. Retrieve the catalog items:
+
[source,sh]
----
$ curl -X GET "$MODERN_CATALOG_URL/catalog/products | jq "
----
+
.Sample Output
[source,json]
----
{
    "itemId": "329299",
    "name": "Redhat",
    "description": "Red Fedora Official Red Hat Fedora",
    "price": 34.99
  },
  {
    "itemId": "329199",
    "name": "catalog",
    "description": "Forge Laptop Sticker JBoss Community Forge Project Sticker",
    "price": 8.5
  },
  {
    "itemId": "165613",
    "name": "catalog",
    "description": "Solid Performance Polo Moir.",
    "price": 17.8
  },
  {
    "itemId": "444456",
    "name": "catalog",
    "description": "Red Fedora Official Red Hat Fedora",
    "price": 34.99
  },
  {
    "itemId": "444435",
    "name": "catalog",
    "description": "Tokyo Official Red Hat Fedora",
    "price": 34.99
  },
  {
    "itemId": "444436",
    "name": "catalog",
    "description": "India Official Red Hat Fedora",
    "price": 34.99
  }
----

. Add a catalog item:
+
[source,sh]
----
$ curl -XPOST -H "Content-Type: application/json" -d '{"itemId":"322","name":"curl","description":"Red Fedora Official Red Hat Fedora","price":34.99}' "$MODERN_CATALOG_URL/catalog/product"
----
